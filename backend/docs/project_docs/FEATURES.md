# 功能逻辑文档 (Functionality Logic)

本文档详细描述了后端各个功能模块的业务逻辑和实现细节。

## 1. 用户认证 (Authentication)
*   **注册 (`POST /api/auth/register`)**:
    *   接收用户名、邮箱、密码。
    *   对密码进行 bcrypt 哈希加密。
    *   创建用户记录，默认角色为 `user`。
*   **登录 (`POST /api/auth/login`)**:
    *   验证用户名和密码。
    *   验证通过后，生成 JWT Token（包含 UserID 和 Role）。
    *   返回 Token 和用户信息。
*   **个人信息 (`GET /api/auth/me`)**:
    *   需携带 Bearer Token。
    *   解析 Token 获取 UserID，查询并返回用户详情。

## 2. 商品管理 (Products)
*   **浏览**:
    *   列表 (`GET /api/products`): 支持分页、筛选。
    *   详情 (`GET /api/products/:id`): 获取商品详细信息、SKU 列表。
    *   评价 (`GET /api/products/:id/reviews`): 获取商品的用户评价。
*   **管理 (Admin)**:
    *   增删改查商品信息。
    *   管理商品 SKU（规格、库存、价格）。

## 3. 购物车 (Cart)
*   **逻辑**:
    *   购物车数据存储在 PostgreSQL `cart_items` 表中。
    *   **添加**: 检查商品/SKU 是否存在，若已存在则增加数量，否则新建记录。
    *   **更新**: 修改数量或选中状态。
    *   **删除**: 移除购物车项。
    *   **查询**: 获取当前用户的购物车列表，包含预加载的商品详情。

## 4. 订单系统 (Orders) - **核心复杂逻辑**
订单创建流程 (`POST /api/orders`) 涉及严格的并发控制和事务处理：

1.  **事务开启**: 整个创建过程在一个 DB 事务中执行。
2.  **获取购物车**: 查询用户选中的购物车商品。
3.  **并发控制 (分布式锁)**:
    *   遍历每个商品，使用 Redis `SetNX` 获取分布式锁 (`lock:product:{id}`)。
    *   防止多个用户同时购买同一件紧俏商品导致超卖。
    *   若获取锁失败，返回系统繁忙提示。
4.  **库存扣减**:
    *   使用 SQL 语句 `UPDATE products SET stock = stock - ? WHERE id = ? AND stock >= ?`。
    *   利用数据库行锁确保存量原子性扣减。
    *   若 `RowsAffected` 为 0，说明库存不足，回滚事务。
5.  **创建订单**:
    *   计算总价，生成唯一订单号。
    *   保存订单主表和订单项表 (`order_items`)。
6.  **清理购物车**: 删除已购买的购物车项。
7.  **事务提交**: 完成数据库操作。
8.  **后续异步操作**:
    *   **Kafka**: 发送 `OrderCreated` 事件，用于后续的数据分析或通知服务。
    *   **Redis 延时队列**: 将订单 ID 加入 ZSet，设置 30 分钟后超时。若用户未支付，调度器将自动取消订单并回滚库存。
    *   **通知**: 创建站内信通知用户订单创建成功。

*   **支付 (`POST /api/orders/:id/pay`)**:
    *   将订单状态从 `0 (待支付)` 更新为 `1 (已支付)`。
*   **确认收货 & 评价**:
    *   状态流转：`2 (待收货)` -> `3 (待评价)` -> `4 (已完成/已评价)`。
*   **售后**:
    *   状态流转：`4 (已完成)` -> `5 (售后中)`。

## 5. 消息与通知 (Notifications & Chat)
*   **WebSocket (`/api/ws`)**:
    *   建立长连接，用于实时聊天和消息推送。
*   **聊天**:
    *   用户与管理员/客服之间的点对点消息。
    *   消息持久化存储在 MongoDB (或 Postgres，视具体实现)。
*   **系统通知**:
    *   订单状态变更等事件会生成 `Notification` 记录。
    *   支持标记已读、查询未读数量。

## 6. 搜索 (Search)
*   **搜索历史**:
    *   记录用户的搜索关键词。
    *   提供添加、查询、清空历史记录的接口。

## 7. 地址管理 (Address)
*   标准的 CRUD 操作，支持设置默认地址。
